<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MACBETH — Motion Comic</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #f5f5f5;
      overflow: hidden;
    }

    /* INTRO */
    .screen-intro {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 18px;
      background:
        radial-gradient(circle at top, #3a0000, transparent 70%),
        radial-gradient(circle at bottom, #080000, #000000);
      transition: opacity 0.7s ease;
      z-index: 5;
    }
    .screen-intro.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .screen-intro h1 {
      font-family: Georgia, "Times New Roman", serif;
      font-size: clamp(4.4rem, 11vw, 8rem);
      letter-spacing: 0.32em;
      color: #c00000;
      margin: 0;
      text-transform: uppercase;
      text-shadow:
        0 0 26px rgba(0,0,0,1),
        0 0 12px rgba(80,0,0,0.9);
    }

    .screen-intro h2 {
      font-family: Georgia, "Times New Roman", serif;
      font-size: clamp(1.4rem, 2.6vw, 2rem);
      margin: 0;
      color: #f5f5f5;
      text-shadow: 0 0 14px rgba(0,0,0,0.9);
    }
    .screen-intro h3 {
      font-size: clamp(1rem, 1.9vw, 1.5rem);
      margin: 6px 0 0;
      color: #d4af37;
      letter-spacing: 0.08em;
    }

    .blood-line {
      width: min(520px, 70vw);
      height: 1px;
      background: linear-gradient(to right, transparent, #d4af37, transparent);
      margin: 16px 0 2px;
      opacity: 0.98;
    }

    .drops {
      position: relative;
      width: 200px;
      height: 110px;
      margin-top: 4px;
    }
    .drop {
      position: absolute;
      bottom: 100%;
      width: 5px;
      height: 16px;
      background: #b30000;
      border-radius: 999px;
      opacity: 0.96;
      animation: drip 1.9s infinite;
      box-shadow: 0 0 12px rgba(0,0,0,0.9);
    }
    .drop::after {
      content: "";
      position: absolute;
      bottom: -6px;
      left: -3px;
      width: 10px;
      height: 10px;
      background: #b30000;
      border-radius: 50%;
    }
    .drop:nth-child(1) { left: 18%; animation-delay: 0s; }
    .drop:nth-child(2) { left: 38%; animation-delay: 0.4s; }
    .drop:nth-child(3) { left: 58%; animation-delay: 0.9s; }
    .drop:nth-child(4) { left: 78%; animation-delay: 1.3s; }

    @keyframes drip {
      0%   { transform: translateY(0); opacity: 0; }
      12%  { opacity: 1; }
      70%  { transform: translateY(50px); opacity: 1; }
      100% { transform: translateY(82px); opacity: 0; }
    }

    /* BLOOD DRIPPING FROM TITLE */
    #title {
      position: relative;
      display: inline-block;
      font-family: Georgia, "Times New Roman", serif;
      font-size: clamp(4.4rem, 11vw, 8rem);
      letter-spacing: 0.32em;
      color: #c00000;
      margin: 0;
      text-transform: uppercase;
      text-shadow:
        0 0 26px rgba(0,0,0,1),
        0 0 12px rgba(80,0,0,0.9);
    }
    #title .drip {
      position: relative;
      display: inline-block;
    }
    #title .drip::after {
      content: "";
      position: absolute;
      top: 82%;
      left: 50%;
      width: 5px;
      height: 0;
      background: #9a0000;
      border-radius: 3px;
      transform: translateX(-50%);
      opacity: 0;
      animation: bloodDrip 2.6s infinite ease-in;
    }
    #title .drip:nth-of-type(1)::after { animation-delay: 0.3s; }
    #title .drip:nth-of-type(2)::after { animation-delay: 1s; }
    #title .drip:nth-of-type(3)::after { animation-delay: 1.7s; }

    @keyframes bloodDrip {
      0% { opacity: 0; height: 0; transform: translate(-50%, 0); }
      10% { opacity: 1; height: 10px; }
      45% { height: 18px; transform: translate(-50%, 26px); opacity: 1; }
      80% { transform: translate(-50%, 54px); opacity: 0.4; }
      100% { opacity: 0; height: 0; transform: translate(-50%, 70px); }
    }

    .controls {
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: center;
      margin-top: 6px;
    }

    /* PLAY BUTTON */
    .play-btn {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      border: 2px solid #d4af37;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow:
        0 0 18px rgba(0,0,0,0.9),
        0 0 16px rgba(212,175,55,0.4);
      transition: all 0.22s ease;
      position: relative;
    }
    .play-btn::before {
      content: "";
      border-style: solid;
      border-width: 12px 0 12px 22px;
      border-color: transparent transparent transparent #d4af37;
      margin-left: 3px;
    }
    .play-btn span {
      position: absolute;
      bottom: -20px;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #e0e0e0;
    }
    .play-btn:hover {
      transform: scale(1.06);
      box-shadow:
        0 0 26px rgba(0,0,0,1),
        0 0 22px rgba(212,175,55,0.7);
      border-color: #ff0000;
    }

    /* MUSIC BUTTON */
    .music-btn {
      min-width: 86px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #555;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #bbbbbb;
      background: radial-gradient(circle at top, rgba(0,0,0,0.9), rgba(20,0,0,1));
      box-shadow: 0 0 10px rgba(0,0,0,0.9);
      transition: all 0.2s ease;
    }
    .music-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #555;
      box-shadow: 0 0 6px rgba(0,0,0,0.8);
    }
    .music-btn.on {
      border-color: #d4af37;
      color: #d4af37;
      box-shadow:
        0 0 16px rgba(0,0,0,1),
        0 0 14px rgba(212,175,55,0.7);
    }
    .music-btn.on .music-dot {
      background: #ff0000;
      box-shadow: 0 0 10px rgba(255,0,0,0.9);
    }

    .hint {
      position: fixed;
      bottom: 16px;
      right: 22px;
      font-size: 0.7rem;
      color: #bbbbbb;
      opacity: 0.9;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      z-index: 20;
      pointer-events: none;
    }

    /* VIEWER */
    .viewer {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      background: #000;
      z-index: 1;
    }
    .viewer.visible { display: flex; }

    #sceneFrame {
      flex: 1;
      border: none;
      width: 100%;
      height: 100%;
      background: #000;
    }

    .nav-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-sizing: border-box;
      background: radial-gradient(circle at top, rgba(0,0,0,0.9), rgba(0,0,0,1));
      color: #ccc;
      font-size: 0.8rem;
      pointer-events: auto;
    }
    .nav-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #555;
      cursor: pointer;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      background: transparent;
      color: #ccc;
    }
    .nav-btn[disabled] { opacity: 0.25; cursor: default; }
    .nav-label {
      flex: 1;
      text-align: center;
      font-size: 0.78rem;
      color: #d4af37;
    }

    /* LOADER */
    .loader {
      position: fixed; inset: 0; display: none; place-items: center;
      background: rgba(0,0,0,0.65); z-index: 10; backdrop-filter: blur(2px);
      font-size: 0.9rem; letter-spacing: .18em; color: #d4af37; text-transform: uppercase;
    }
    .loader.visible { display: grid; }
  </style>
</head>
<body>

  <!-- INTRO GLOBAL -->
  <div class="screen-intro" id="intro">
    <h1 id="title">
      M<span class="drip">A</span>C<span class="drip">B</span>E<span class="drip">T</span>H
    </h1>
    <h2>William Shakespeare</h2>
    <div class="blood-line"></div>
    <h3>Visual Adaptation: David Hipperdinger — UNPAZ</h3>

    <div class="controls">
      <!-- PLAY -->
      <div class="play-btn" id="playButton">
        <span>PLAY</span>
      </div>

      <!-- MUSIC TOGGLE (permiso global) -->
      <div class="music-btn" id="musicButton">
        <div class="music-dot"></div>
        <span>MUSIC</span>
      </div>
    </div>

    <div class="drops">
      <div class="drop"></div><div class="drop"></div>
      <div class="drop"></div><div class="drop"></div>
    </div>
  </div>

  <div class="hint" id="hint">PRESS PLAY TO BEGIN · TOGGLE MUSIC FOR FULL EXPERIENCE</div>

  <!-- VIEWER -->
  <div class="viewer" id="viewer">
    <!-- IMPORTANT: allow="autoplay" para liberar audio del iframe -->
    <iframe id="sceneFrame" title="Macbeth Scene" allow="autoplay"></iframe>
    <div class="nav-bar">
      <button class="nav-btn" id="prevBtn">&larr; PREVIOUS</button>
      <div class="nav-label" id="sceneLabel"></div>
      <button class="nav-btn" id="nextBtn">NEXT &rarr;</button>
    </div>
  </div>

  <!-- LOADER -->
  <div class="loader" id="loader">LOADING SCENE…</div>

  <!-- Música SOLO de la intro (si el usuario la enciende) -->
  <audio id="introMusic" src="intro.mp3" loop></audio>

  <script>
    const introEl = document.getElementById('intro');
    const hintEl = document.getElementById('hint');
    const viewerEl = document.getElementById('viewer');
    const frameEl = document.getElementById('sceneFrame');
    const labelEl = document.getElementById('sceneLabel');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const playButton = document.getElementById('playButton');
    const musicButton = document.getElementById('musicButton');
    const introMusic = document.getElementById('introMusic');
    const loaderEl = document.getElementById('loader');

  const scenes = [
  { file: 'act1-scene1.html', label: 'Act I · Scene I — The Three Witches' },
  { file: 'act1-scene2.html', label: 'Act I · Scene II — The King Rewards Macbeth' },
  { file: 'act1-scene3.html', label: 'Act I · Scene III — Macbeth Meets the Witches' }
];



    let introVisible = true;
    let currentIndex = 0;
    let musicOn = false; // permiso global

    // --- NUEVO: helpers para ocultar/mostrar NEXT sin cambiar tu estilo ---
    function lockNext() {
      nextBtn.disabled = true;
      nextBtn.style.visibility = 'hidden';
    }
    function unlockNext() {
      nextBtn.disabled = false;
      nextBtn.style.visibility = 'visible';
    }

    function updateMusicButton() {
      if (musicOn) musicButton.classList.add('on');
      else musicButton.classList.remove('on');
    }

    function startIntroMusic() {
      if (!introVisible || !musicOn || !introMusic) return;
      introMusic.volume = 0.6;
      introMusic.play().catch(() => {});
    }

    function stopIntroMusic() {
      if (!introMusic) return;
      introMusic.pause();
      introMusic.currentTime = 0;
    }

    function toggleMusic() {
      // Este toggle es el consentimiento global
      musicOn = !musicOn;
      updateMusicButton();

      // Mientras estamos en la intro, prende o apaga la música de menú
      if (introVisible) {
        if (musicOn) startIntroMusic();
        else stopIntroMusic();
      }

      // Guardamos preferencia
      try { localStorage.setItem('macbethMusicEnabled', musicOn ? '1':'0'); } catch(e){}

      // Enviamos la preferencia a la escena actual (si hay iframe cargado)
      postMusicPrefToScene();
    }

    function startComic() {
      if (!introVisible) return;
      introVisible = false;
      introEl.classList.add('hidden');
      hintEl.style.display = 'none';
      viewerEl.classList.add('visible');
      stopIntroMusic();
      loadScene(0);
    }

    function backToIntro() {
      viewerEl.classList.remove('visible');
      introEl.classList.remove('hidden');
      introVisible = true;
      hintEl.style.display = 'block';
      frameEl.src = '';
      stopIntroMusic();
    }

    function loadScene(index) {
      if (index < 0 || index >= scenes.length) return;
      currentIndex = index;

      // loader on
      loaderEl.classList.add('visible');

      // --- NUEVO: bloquear NEXT antes de cargar para evitar "flash" ---
      lockNext();

      // onload para ocultar loader y mandar preferencia
      frameEl.onload = () => {
        postMusicPrefToScene();
        loaderEl.classList.remove('visible');
      };

      frameEl.src = scenes[index].file;
      labelEl.textContent = scenes[index].label;

      prevBtn.disabled = false;
      // El estado de NEXT ahora lo determina la escena; de todos modos,
      // si es la última escena, lo dejamos deshabilitado.
      if (index === scenes.length - 1) lockNext();
    }

    function nextScene() {
      if (currentIndex < scenes.length - 1) loadScene(currentIndex + 1);
    }

    function prevScene() {
      if (currentIndex > 0) loadScene(currentIndex - 1);
      else backToIntro();
    }

    function postMusicPrefToScene() {
      if (!frameEl.contentWindow) return;
      frameEl.contentWindow.postMessage({ type: 'MACBETH_MUSIC_PREF', enabled: musicOn }, '*');
    }

    // Escuchar pedidos desde la escena (p.ej. cuando termina el minijuego)
    window.addEventListener('message', (e) => {
      if (!e.data) return;
      if (e.data.type === 'MACBETH_REQUEST_NEXT') {
        nextScene();
      }
      // --- NUEVO: control estricto del botón NEXT según mensajes de la escena ---
      else if (e.data.type === 'MACBETH_DISABLE_NEXT') {
        lockNext();
      } else if (e.data.type === 'MACBETH_ENABLE_NEXT') {
        // Solo mostrar NEXT si no es la última (por si acaso)
        if (currentIndex < scenes.length - 1) unlockNext();
      }
    });

    // PLAY
    playButton.addEventListener('click', (e) => { e.stopPropagation(); startComic(); });

    // MUSIC TOGGLE
    musicButton.addEventListener('click', (e) => { e.stopPropagation(); toggleMusic(); });

    // Nav buttons
    prevBtn.addEventListener('click', prevScene);
    nextBtn.addEventListener('click', nextScene);

    // Teclado: solo navegación (PLAY sigue con click/Enter/Espacio en intro)
    window.addEventListener('keydown', (e) => {
      const key = e.key;

      if (introVisible) {
        if (key === 'Enter' || key === ' ') { e.preventDefault(); startComic(); }
        return;
      }

      if (key === 'ArrowRight') { e.preventDefault(); nextScene(); }
      else if (key === 'ArrowLeft') { e.preventDefault(); prevScene(); }
    });

    // Click en escenas para navegar (zonas)
    window.addEventListener('pointerdown', (e) => {
      if (introVisible) return;
      if (!viewerEl.classList.contains('visible')) return;
      if (e.target.closest('.nav-btn')) return;

      const x = e.clientX;
      const w = window.innerWidth;

      if (x > w * 0.6) nextScene();
      else if (x < w * 0.4) prevScene();
      else nextScene();
    });

    // Cargar preferencia previa (opcional)
    try {
      const saved = localStorage.getItem('macbethMusicEnabled');
      if (saved === '1') { musicOn = true; updateMusicButton(); }
    } catch (e) {}

    // Estado inicial: por si el usuario entra directo al viewer
    lockNext();
  </script>
</body>
</html>
