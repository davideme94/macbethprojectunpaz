<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Macbeth — Act I Scene V</title>
  <style>
    html, body {
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:#000;
      overflow:hidden;
    }
    #game {
      width:100%;
      height:100%;
    }
  </style>
</head>
<body>
<div id="game"></div>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
<script>
  // ====== Permiso de música global desde index ======
  let musicEnabled = false;
  window.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'MACBETH_MUSIC_PREF') {
      musicEnabled = !!event.data.enabled;
      if (window.sceneMusic) {
        if (musicEnabled && !window.sceneMusic.isPlaying) window.sceneMusic.play();
        else if (!musicEnabled && window.sceneMusic.isPlaying) window.sceneMusic.stop();
      }
    }
  });

  class Scene5LadyMacbethRise extends Phaser.Scene {
    constructor() {
      super('Scene5LadyMacbethRise');

      this.bgMusic = null;
      this.scaleFactor = 1;

      // personajes
      this.lady = null;
      this.macbeth = null;

      this.nameTexts = [];

      // elementos de fondo
      this.fireGlow = null;

      // texto narrador
      this.narrText = null;

      // cuenta atrás
      this.countdownText = null;
      this.instructionsText = null;
      this.subInstructionsText = null;

      // minijuego: determinación
      this.thoughtBubble = null;
      this.thoughtText = null;
      this.darkBarBg = null;
      this.darkBarFill = null;
      this.darkness = 0;      // acá es "determinación"
      this.maxDarkness = 7;   // cantidad de clics / frases

      this.magicSymbols = [];
      this.clickCount = 0;
      this.phrases = [];
      this.currentPhraseIndex = 0;
    }

    preload() {
      this.load.image('ladymacbeth', 'ladymacbeth.png');
      this.load.image('macbeth', 'macbeth.png');

      this.load.audio('scene5_ambience', 'rain.mp3');

      // textura pared y ventana simple
      let g = this.add.graphics();
      g.fillStyle(0x131018,1);
      g.fillRect(0,0,200,200);
      g.generateTexture('wallBlock',200,200);

      g.clear();
      g.fillStyle(0x101320,1);
      g.fillRect(0,0,120,160);
      g.fillStyle(0x1b2240,1);
      g.fillRect(10,10,100,140);
      g.generateTexture('windowTall',120,160);

      g.clear();
      g.fillStyle(0x302018,1);
      g.fillRect(0,0,120,80);
      g.fillStyle(0xffaa55,1);
      g.fillRect(10,30,100,20);
      g.generateTexture('fireplace',120,80);

      g.destroy();
    }

    create() {
      const w = this.scale.width;
      const h = this.scale.height;
      this.scaleFactor = Phaser.Math.Clamp(Math.min(w/1600, h/900), 0.7, 1.2);

      // ===== Fondo sala interior del castillo =====
      const bg = this.add.image(0,0,'wallBlock')
        .setOrigin(0,0)
        .setDisplaySize(w,h);

      // ventana al fondo izquierda
      const windowImg = this.add.image(w*0.23, h*0.33, 'windowTall')
        .setOrigin(0.5,0.5)
        .setScale(1.6*this.scaleFactor)
        .setAlpha(0.9);

      // “tormenta” afuera de la ventana (brillo frío)
      const blueGlow = this.add.circle(
        windowImg.x,
        windowImg.y+5*this.scaleFactor,
        110*this.scaleFactor,
        0x5b7cff,
        0.18
      );
      blueGlow.setBlendMode(Phaser.BlendModes.ADD);

      // chimenea al fondo derecha
      const fireplace = this.add.image(w*0.8, h*0.68, 'fireplace')
        .setOrigin(0.5,1)
        .setScale(1.7*this.scaleFactor)
        .setAlpha(0.9);

      // brillo del fuego
      this.fireGlow = this.add.circle(
        fireplace.x,
        fireplace.y-40*this.scaleFactor,
        130*this.scaleFactor,
        0xffa84a,
        0.22
      );
      this.fireGlow.setBlendMode(Phaser.BlendModes.ADD);

      // “suelo” oscuro delante
      const ground = this.add.graphics();
      const horizon = h*0.72;
      ground.fillStyle(0x070608,1);
      ground.fillRect(0,horizon,w,h-horizon+10);

      // ===== Música / ambiente =====
      this.bgMusic = this.sound.add('scene5_ambience', { loop:true, volume:0.5 });
      window.sceneMusic = this.bgMusic;
      this.input.once('pointerdown', () => {
        if (this.sound?.context?.state === 'suspended') this.sound.context.resume();
        if (musicEnabled && !this.bgMusic.isPlaying) this.bgMusic.play();
      });

      // ===== Título =====
      const t1 = Phaser.Math.Clamp(26*this.scaleFactor,18,30);
      const t2 = Phaser.Math.Clamp(32*this.scaleFactor,22,36);

      this.add.text(24*this.scaleFactor, 18*this.scaleFactor,
        'ACT I · SCENE V — "Lady Macbeth reads the letter"',
        { fontFamily:'Georgia', fontSize:t1+'px', color:'#cccccc' }
      );

      this.add.text(24*this.scaleFactor, 18*this.scaleFactor + t1 + 4,
        'She calls for courage · Her determination grows',
        { fontFamily:'Georgia', fontSize:t2+'px', color:'#d4af37' }
      );

      // ===== Personajes =====
      const baseY = horizon - 10*this.scaleFactor;
      const targetHeight = Math.min(h*0.42, 360*this.scaleFactor);

      this.lady = this.add.sprite(w*0.60, baseY, 'ladymacbeth');
      this.macbeth = this.add.sprite(w*0.25, baseY, 'macbeth').setAlpha(0); // entra después

      [this.lady, this.macbeth].forEach(s => {
        const sc = targetHeight / s.height;
        s.setScale(sc);
      });

      // nombres
      const nameStyle = {
        fontFamily:'Georgia',
        fontSize:(16*this.scaleFactor)+'px',
        color:'#d4af37'
      };

      const makeName = (sprite, text) => {
        const t = this.add.text(
          sprite.x,
          sprite.y + sprite.displayHeight/2 + 8*this.scaleFactor,
          text,
          nameStyle
        ).setOrigin(0.5,0);
        this.nameTexts.push(t);
      };

      makeName(this.lady, 'Lady Macbeth');

      // texto narrador
      const narrSize = Phaser.Math.Clamp(22*this.scaleFactor,18,26);
      this.narrText = this.add.text(
        w/2, h*0.14,
        '',
        {
          fontFamily:'Georgia',
          fontSize:narrSize+'px',
          color:'#ffffff',
          align:'center',
          wordWrap:{ width:w*0.9 }
        }
      ).setOrigin(0.5).setAlpha(0);

      // cinemática
      this.playCinematic();

      // bloquear NEXT desde el inicio
      if (window.parent) {
        window.parent.postMessage({ type:'MACBETH_DISABLE_NEXT' }, '*');
      }

      this.events.once('shutdown', () => {
        this.sound.stopAll();
      });
    }

    update(time, delta) {
      // ligero “flicker” del fuego
      if (this.fireGlow) {
        const baseR = 130*this.scaleFactor;
        const pulse = Math.sin(time*0.004)*8*this.scaleFactor;
        this.fireGlow.setRadius(baseR + pulse);
        this.fireGlow.setAlpha(0.18 + Math.abs(Math.sin(time*0.003))*0.12);
      }
    }

    // ===== Cinemática narrador =====
    playCinematic() {
      const w = this.scale.width;
      const h = this.scale.height;

      const lines = [
        'At Macbeth’s castle, Lady Macbeth reads a letter from her husband.',
        'He tells her about the witches and their strange prophecy.',
        'They said he will be king one day.',
        'Lady Macbeth thinks Macbeth is too kind to take the crown.',
        'She decides she must be strong and help him.'
      ];

      let step = 0;

      const showNext = () => {
        if (step >= lines.length) {
          // luego de la narración, vamos a su mente
          this.time.delayedCall(2200, () => {
            this.startSpellCinematic();
          });
          return;
        }

        this.narrText.setText(lines[step]);
        this.narrText.setAlpha(0);
        this.narrText.y = h*0.14 + 10*this.scaleFactor;

        this.tweens.add({
          targets:this.narrText,
          alpha:1,
          y:h*0.14,
          duration:450,
          ease:'Quad.easeOut',
          onComplete: () => {
            this.time.delayedCall(4200, () => {
              this.tweens.add({
                targets:this.narrText,
                alpha:0,
                duration:350,
                ease:'Quad.easeIn',
                onComplete: () => {
                  step++;
                  showNext();
                }
              });
            });
          }
        });
      };

      showNext();
    }

    // ===== Cinemática: “Make me a man! Give me courage.” =====
    startSpellCinematic() {
      const w = this.scale.width;
      const h = this.scale.height;

      const fontSize = Phaser.Math.Clamp(20*this.scaleFactor,16,24);
      const bubble = this.makeBubble(
        "Macbeth wants to be king,\nbut he is too kind.\n\nI must become stronger.\nMake me a man! Give me courage.",
        this.lady,
        fontSize
      );
      bubble.alpha = 0;

      this.tweens.add({
        targets:bubble,
        alpha:1,
        y:bubble.y - 6,
        duration:700,
        ease:'Quad.easeOut'
      });

      this.time.delayedCall(5200, () => {
        this.tweens.add({
          targets:bubble,
          alpha:0,
          duration:600,
          ease:'Quad.easeIn'
        });
      });

      const mindText = this.add.text(
        w/2, h*0.22,
        'Now we look inside Lady Macbeth’s mind.',
        {
          fontFamily:'Georgia',
          fontSize: Phaser.Math.Clamp(24*this.scaleFactor,18,28)+'px',
          color:'#d4af37',
          align:'center'
        }
      ).setOrigin(0.5).setAlpha(0);

      this.tweens.add({
        targets:mindText,
        alpha:1,
        duration:600
      });

      this.time.delayedCall(4200, () => {
        this.tweens.add({
          targets:mindText,
          alpha:0,
          duration:600,
          onComplete: () => {
            mindText.destroy();
            this.startCountdown();
          }
        });
      });
    }

    // ===== Cuenta regresiva 10 → 0 =====
    startCountdown() {
      const w = this.scale.width;
      const h = this.scale.height;

      this.countdownText = this.add.text(
        w/2, h*0.46, '',
        {
          fontFamily:'Georgia',
          fontSize: Phaser.Math.Clamp(80*this.scaleFactor,52,110)+'px',
          color:'#ff5555',
          align:'center'
        }
      ).setOrigin(0.5).setAlpha(0);

      this.instructionsText = this.add.text(
        w/2, h*0.26,
        'Help Lady Macbeth focus her power.',
        {
          fontFamily:'Georgia',
          fontSize: Phaser.Math.Clamp(26*this.scaleFactor,20,30)+'px',
          color:'#d4af37',
          align:'center'
        }
      ).setOrigin(0.5).setAlpha(1);

      this.subInstructionsText = this.add.text(
        w/2, h*0.31,
        'Click on the magic symbols to give her determination.',
        {
          fontFamily:'system-ui, sans-serif',
          fontSize: Phaser.Math.Clamp(18*this.scaleFactor,14,22)+'px',
          color:'#ffffff',
          align:'center',
          wordWrap:{ width:w*0.9 }
        }
      ).setOrigin(0.5).setAlpha(1);

      let count = 10;

      const tick = () => {
        if (count > 0) {
          this.countdownText.setAlpha(1);
          this.countdownText.setScale(1);
          this.countdownText.setText(count.toString());

          this.tweens.add({
            targets:this.countdownText,
            scale:1.25,
            duration:260,
            yoyo:true,
            ease:'Quad.easeOut'
          });

          this.time.delayedCall(1000, () => {
            count--;
            tick();
          });
        } else {
          this.countdownText.setAlpha(1);
          this.countdownText.setScale(1);
          this.countdownText.setText('GO!');

          this.tweens.add({
            targets:this.countdownText,
            scale:1.35,
            duration:350,
            yoyo:true,
            ease:'Quad.easeOut',
            onComplete: () => {
              this.tweens.add({
                targets:this.countdownText,
                alpha:0,
                duration:320,
                onComplete: () => {
                  this.countdownText.destroy();
                  this.startDeterminationGame();
                }
              });
            }
          });
        }
      };

      tick();
    }

    // ===== Minijuego: Help Lady Macbeth Focus Her Power =====
    startDeterminationGame() {
      const w = this.scale.width;
      const h = this.scale.height;

      // barra de determinación (antes "darkness")
      const barW = Math.min(w*0.6, 420*this.scaleFactor);
      const barH = 20*this.scaleFactor;
      const barY = h*0.38;

      this.darkBarBg = this.add.rectangle(
        w/2, barY, barW, barH, 0x111111, 0.9
      ).setStrokeStyle(2, 0xd4af37);

      this.darkBarFill = this.add.rectangle(
        w/2 - barW/2, barY, 0, barH-4*this.scaleFactor, 0x5b1b3b, 1
      ).setOrigin(0,0.5);

      this.add.text(
        w/2, barY - 26*this.scaleFactor,
        'Lady Macbeth’s Determination',
        {
          fontFamily:'Georgia',
          fontSize:(18*this.scaleFactor)+'px',
          color:'#d4af37'
        }
      ).setOrigin(0.5);

      // burbuja de pensamiento central
      const fontSize = Phaser.Math.Clamp(22*this.scaleFactor,16,26);
      const bubbleMaxWidth = w*0.7;

      const bubbleContainer = this.makeThoughtBubble(
        w/2, h*0.52,
        '...',
        fontSize,
        bubbleMaxWidth
      );
      this.thoughtBubble = bubbleContainer.bg;
      this.thoughtText = bubbleContainer.text;

      // frases que se muestran a medida que clickean símbolos
      this.phrases = [
        'Macbeth wants to be king.',
        'But he is too kind.',
        'He will not take the crown by himself.',
        'I must be stronger than him.',
        'Make me a man! Give me courage.',
        'Take away my fear and softness.',
        'I will help Macbeth become king!'
      ];

      this.currentPhraseIndex = 0;
      this.darkness = 0;
      this.maxDarkness = this.phrases.length;
      this.clickCount = 0;

      this.showCurrentPhrase();

      // crear símbolos mágicos alrededor de Lady Macbeth
      this.createMagicSymbols();
    }

    createMagicSymbols() {
      const baseX = this.lady.x;
      const baseY = this.lady.y - this.lady.displayHeight/2 - 10*this.scaleFactor;
      const radius = 140*this.scaleFactor;
      const total = this.phrases.length;

      this.magicSymbols = [];

      for (let i = 0; i < total; i++) {
        const angleDeg = -70 + (140/(total-1))*i; // arco frente a ella
        const angle = Phaser.Math.DegToRad(angleDeg);
        const x = baseX + Math.cos(angle)*radius;
        const y = baseY + Math.sin(angle)*radius;

        const symbol = this.createMagicSymbol(x, y, i);
        this.magicSymbols.push(symbol);
      }
    }

    createMagicSymbol(x, y, index) {
      const r = 24*this.scaleFactor;
      const g = this.add.graphics();
      g.fillStyle(0x2b2148, 0.95);
      g.fillCircle(0,0,r);
      g.lineStyle(2, 0xd4af37, 1);
      g.strokeCircle(0,0,r);

      const txt = this.add.text(0,0,'✦',{
        fontFamily:'Georgia',
        fontSize:(22*this.scaleFactor)+'px',
        color:'#ffffff'
      }).setOrigin(0.5);

      const cont = this.add.container(x,y,[g,txt]);
      cont.setSize(r*2,r*2);
      cont.setInteractive({ useHandCursor:true });
      cont.symbolIndex = index;
      cont.clicked = false;

      cont.on('pointerover', () => {
        this.tweens.add({
          targets:cont,
          scale:1.12,
          duration:120
        });
      });

      cont.on('pointerout', () => {
        this.tweens.add({
          targets:cont,
          scale:1,
          duration:120
        });
      });

      cont.on('pointerdown', () => {
        this.handleSymbolClick(cont);
      });

      return cont;
    }

    showCurrentPhrase() {
      if (!this.thoughtText) return;
      const phrase = this.phrases[this.currentPhraseIndex] || '';
      this.thoughtText.setText(phrase);
    }

    handleSymbolClick(symbol) {
      if (symbol.clicked) return;
      symbol.clicked = true;

      // animación del símbolo
      this.tweens.add({
        targets:symbol,
        scale:1.3,
        duration:120,
        yoyo:true,
        onComplete: () => {
          this.tweens.add({
            targets:symbol,
            alpha:0,
            duration:300,
            onComplete: () => symbol.destroy()
          });
        }
      });

      this.clickCount = Math.min(this.clickCount + 1, this.maxDarkness);
      this.darkness = this.clickCount;
      this.updateDetermBar();

      // avanzar frase
      if (this.currentPhraseIndex < this.phrases.length-1) {
        this.currentPhraseIndex++;
        this.showCurrentPhrase();
      }

      // si ya clickeó todos, final
      if (this.clickCount >= this.maxDarkness) {
        this.time.delayedCall(800, () => {
          this.triggerFinalDetermination();
        });
      }
    }

    updateDetermBar() {
      if (!this.darkBarFill || !this.darkBarBg) return;
      const fullWidth = this.darkBarBg.width - 4*this.scaleFactor;
      const ratio = Phaser.Math.Clamp(this.darkness/this.maxDarkness, 0, 1);
      const targetWidth = fullWidth * ratio;

      this.tweens.add({
        targets:this.darkBarFill,
        width:targetWidth,
        duration:320,
        ease:'Quad.easeOut'
      });
    }

    triggerFinalDetermination() {
      const w = this.scale.width;
      const h = this.scale.height;

      // asegurar frase final
      this.thoughtText.setText('I will help Macbeth become king!');

      // texto grande arriba
      const big = this.add.text(
        w/2, h*0.18,
        'HER DETERMINATION IS COMPLETE.',
        {
          fontFamily:'Georgia',
          fontSize: Phaser.Math.Clamp(34*this.scaleFactor,26,44)+'px',
          color:'#ff4444',
          align:'center'
        }
      ).setOrigin(0.5).setAlpha(0);

      this.tweens.add({
        targets:big,
        alpha:1,
        scale:1.08,
        duration:450,
        ease:'Back.Out'
      });

      // oscurecer un poco la escena
      const darkOverlay = this.add.rectangle(
        0,0,w,h,0x000000,0.35
      ).setOrigin(0,0);
      darkOverlay.alpha = 0;

      this.tweens.add({
        targets:darkOverlay,
        alpha:0.35,
        duration:550
      });

      this.time.delayedCall(2200, () => {
        this.finishGame();
      });
    }

    finishGame() {
      const w = this.scale.width;
      const h = this.scale.height;

      // resumen
      const summary = this.add.text(
        w/2, h*0.7,
        "Lady Macbeth reads Macbeth’s letter about the witches.\n" +
        "She thinks he is too kind to take the crown.\n" +
        "She calls for courage and builds her determination.\n" +
        "She decides to help Macbeth become king.",
        {
          fontFamily:'Georgia',
          fontSize: Phaser.Math.Clamp(20*this.scaleFactor,16,24)+'px',
          color:'#ffffff',
          align:'center',
          wordWrap:{ width:w*0.9 },
          lineSpacing: 14
        }
      ).setOrigin(0.5).setAlpha(0);

      this.tweens.add({
        targets:summary,
        alpha:1,
        duration:700
      });

      // hacer aparecer a Macbeth y breve diálogo
      if (this.macbeth) {
        this.tweens.add({
          targets:this.macbeth,
          alpha:1,
          x:this.macbeth.x + 20*this.scaleFactor,
          duration:800,
          ease:'Quad.easeOut'
        });

        this.time.delayedCall(1200, () => {
          const fontSize = Phaser.Math.Clamp(18*this.scaleFactor,14,22);
          const bubbleMac = this.makeBubble(
            "The king is coming here tonight.",
            this.macbeth,
            fontSize
          );
          bubbleMac.alpha = 0;

          this.tweens.add({
            targets:bubbleMac,
            alpha:1,
            y:bubbleMac.y - 6,
            duration:600
          });

          this.time.delayedCall(2600, () => {
            const bubbleLady = this.makeBubble(
              "Welcome him with a smile...\nI will plan the rest.",
              this.lady,
              fontSize
            );
            bubbleLady.alpha = 0;
            this.tweens.add({
              targets:bubbleLady,
              alpha:1,
              y:bubbleLady.y - 6,
              duration:600
            });
          });
        });
      }

      // habilitar NEXT
      if (window.parent) {
        window.parent.postMessage({ type:'MACBETH_ENABLE_NEXT' }, '*');
      }
    }

    // ===== Helpers gráficos =====
    makeBubble(text, sprite, fontSize) {
      const padding = 14;
      const maxWidth = 380*this.scaleFactor;

      const txt = this.add.text(0,0,text,{
        fontFamily:'system-ui, sans-serif',
        fontSize:fontSize+'px',
        color:'#ffffff',
        align:'center',
        wordWrap:{ width:maxWidth }
      });

      const w = Math.min(maxWidth, txt.width) + padding*2;
      const h = txt.height + padding*2;

      const g = this.add.graphics();
      g.fillStyle(0x000000,0.9);
      g.lineStyle(2,0xffffff,1);
      g.fillRoundedRect(-w/2,-h/2,w,h,18);
      g.strokeRoundedRect(-w/2,-h/2,w,h,18);
      g.fillTriangle(0,h/2, -14,h/2+14, 14,h/2+14);

      txt.setPosition(-txt.width/2, -txt.height/2);

      let x = sprite.x;
      let y = sprite.y - sprite.displayHeight/2 - (50*this.scaleFactor);

      const cont = this.add.container(x,y,[g,txt]);
      return cont;
    }

    makeThoughtBubble(x,y,text,fontSize,maxWidth) {
      const padding = 18;

      const txt = this.add.text(0,0,text,{
        fontFamily:'system-ui, sans-serif',
        fontSize:fontSize+'px',
        color:'#ffffff',
        align:'center',
        wordWrap:{ width:maxWidth }
      });

      const w = Math.min(maxWidth, txt.width) + padding*2;
      const h = txt.height + padding*2;

      const g = this.add.graphics();
      g.fillStyle(0x000000,0.92);
      g.lineStyle(2,0xd4af37,1);
      g.fillRoundedRect(-w/2,-h/2,w,h,20);
      g.strokeRoundedRect(-w/2,-h/2,w,h,20);

      txt.setPosition(-txt.width/2, -txt.height/2);

      const bg = this.add.container(x,y,[g,txt]);
      return { bg, text:txt };
    }

    createChoiceButton(x,y,w,h,label,bgColor) {
      // (no se usa en esta escena, pero dejo el helper por si lo necesitás después)
      const rect = this.add.rectangle(0,0,w,h,bgColor,1)
        .setStrokeStyle(2,0xd4af37,1);
      const txt = this.add.text(0,0,label,{
        fontFamily:'system-ui, sans-serif',
        fontSize:(18*this.scaleFactor)+'px',
        color:'#ffffff'
      }).setOrigin(0.5);

      const btn = this.add.container(x,y,[rect,txt]);
      btn.setSize(w,h);
      btn.setInteractive({ useHandCursor:true });

      btn.on('pointerover', () => {
        this.tweens.add({
          targets:btn,
          scale:1.04,
          duration:120
        });
      });

      btn.on('pointerout', () => {
        this.tweens.add({
          targets:btn,
          scale:1,
          duration:120
        });
      });

      return btn;
    }
  }

  // ===== Config Phaser =====
  const config = {
    type: Phaser.AUTO,
    parent: 'game',
    width: window.innerWidth,
    height: window.innerHeight,
    backgroundColor: '#000000',
    pixelArt: true,
    roundPixels: true,
    powerPreference: 'high-performance',
    scene: [Scene5LadyMacbethRise]
  };

  const game = new Phaser.Game(config);

  window.addEventListener('resize', () => {
    if (game?.scale) game.scale.resize(window.innerWidth, window.innerHeight);
  });
</script>
</body>
</html>
