<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Macbeth — Act I Scene VI</title>
  <style>
    html, body {
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:#000;
      overflow:hidden;
    }
    #game {
      width:100%;
      height:100%;
    }
  </style>
</head>
<body>
<div id="game"></div>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
<script>
  // ====== Permiso de música global desde index ======
  let musicEnabled = false;
  window.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'MACBETH_MUSIC_PREF') {
      musicEnabled = !!event.data.enabled;
      if (window.sceneMusic) {
        if (musicEnabled && !window.sceneMusic.isPlaying) window.sceneMusic.play();
        else if (!musicEnabled && window.sceneMusic.isPlaying) window.sceneMusic.stop();
      }
    }
  });

  class Scene6SpotDifference extends Phaser.Scene {
    constructor() {
      super('Scene6SpotDifference');

      this.bgMusic = null;
      this.scaleFactor = 1;

      this.narrText = null;
      this.infoText = null;

      this.differenceItems = [];
      this.foundCount = 0;
      this.totalDifferences = 4;
      this.counterText = null;
    }

    preload() {
      // personajes e imágenes
      this.load.image('duncan', 'duncan.png');
      this.load.image('macbeth', 'macbeth.png');
      this.load.image('ladymacbeth', 'ladymacbeth.png');

      this.load.image('macbethdoubting', 'macbethdoubting.png');
      this.load.image('ladymacbethdark', 'ladymacbethdark.png');
      this.load.image('castle', 'castle.png');
      this.load.image('trees', 'trees.png');
      this.load.image('blood', 'blood.png');
      this.load.image('dagger', 'dagger.png');

      // ambiente
      this.load.audio('scene6_ambience', 'rain.mp3');
    }

    create() {
      const w = this.scale.width;   // 1600 virtual
      const h = this.scale.height;  // 900 virtual
      this.scaleFactor = Phaser.Math.Clamp(Math.min(w/1600, h/900), 0.7, 1.2);

      // fondo cielo
      const sky = this.add.graphics();
      sky.fillGradientStyle(0x05050a,0x05050a,0x151019,0x151019,1);
      sky.fillRect(0,0,w,h);

      // suelo
      const horizon = h*0.7;
      const ground = this.add.graphics();
      ground.fillStyle(0x050506,1);
      ground.fillRect(0,horizon,w,h-horizon+10);

      // música ambiente
      this.bgMusic = this.sound.add('scene6_ambience', { loop:true, volume:0.4 });
      window.sceneMusic = this.bgMusic;
      this.input.once('pointerdown', () => {
        if (this.sound?.context?.state === 'suspended') this.sound.context.resume();
        if (musicEnabled && !this.bgMusic.isPlaying) this.bgMusic.play();
      });

      // título
      const t1 = Phaser.Math.Clamp(26*this.scaleFactor,18,30);
      const t2 = Phaser.Math.Clamp(30*this.scaleFactor,22,36);

      this.add.text(24*this.scaleFactor, 18*this.scaleFactor,
        'ACT I · SCENE VI — "At Macbeth\'s castle"',
        { fontFamily:'Georgia', fontSize:t1+'px', color:'#bbbbbb' }
      );

      this.add.text(24*this.scaleFactor, 18*this.scaleFactor + t1 + 4,
        'The king arrives · Appearance vs Reality',
        { fontFamily:'Georgia', fontSize:t2+'px', color:'#d4af37' }
      );

      // línea divisoria
      const midX = w/2;
      this.add.rectangle(midX, h*0.54, 2, h*0.7, 0x333333, 0.8).setOrigin(0.5);

      // etiquetas columnas
      const colTitleStyle = {
        fontFamily:'Georgia',
        fontSize:(20*this.scaleFactor)+'px',
        color:'#d4af37'
      };
      this.add.text(w*0.23, h*0.26, 'APPEARANCE', colTitleStyle).setOrigin(0.5);
      this.add.text(w*0.77, h*0.26, 'REALITY', colTitleStyle).setOrigin(0.5);

      // texto narrador
      const narrSize = Phaser.Math.Clamp(22*this.scaleFactor,18,26);
      this.narrText = this.add.text(
        w/2, h*0.14,
        '',
        {
          fontFamily:'Georgia',
          fontSize:narrSize+'px',
          color:'#ffffff',
          align:'center',
          wordWrap:{ width:w*0.9 }
        }
      ).setOrigin(0.5).setAlpha(0);

      // texto informativo inferior
      this.infoText = this.add.text(
        w/2, h*0.82,
        '',
        {
          fontFamily:'Georgia',
          fontSize:Phaser.Math.Clamp(20*this.scaleFactor,16,24)+'px',
          color:'#ffffff',
          align:'center',
          wordWrap:{ width:w*0.9 },
          lineSpacing: 6
        }
      ).setOrigin(0.5).setAlpha(0);

      // bloquear NEXT desde el inicio
      if (window.parent) {
        window.parent.postMessage({ type:'MACBETH_DISABLE_NEXT' }, '*');
      }

      // crear columnas
      this.createColumns(horizon);

      // secuencia de introducción
      this.playIntro();
    }

    createColumns(horizon) {
      const w = this.scale.width;
      const h = this.scale.height;

      const leftX  = w*0.23;
      const rightX = w*0.77;

      // ESCALAS MÁS PEQUEÑAS
      const castleScale = 0.28 * this.scaleFactor;
      const treesScale  = 0.30 * this.scaleFactor;
      const charScale   = 0.26 * this.scaleFactor;

      // APPEARANCE — izquierda (todo bien separado)
      this.castleLeft = this.add.sprite(leftX + 10*this.scaleFactor, horizon-130*this.scaleFactor, 'castle')
        .setScale(castleScale).setOrigin(0.5,1);
      this.treesLeft = this.add.sprite(leftX - 90*this.scaleFactor, horizon-110*this.scaleFactor, 'trees')
        .setScale(treesScale).setOrigin(0.5,1);

      this.duncanLeft = this.add.sprite(leftX - 90*this.scaleFactor, horizon, 'duncan')
        .setScale(charScale).setOrigin(0.5,1);
      this.macbethLeft = this.add.sprite(leftX + 5*this.scaleFactor, horizon, 'macbeth')
        .setScale(charScale).setOrigin(0.5,1);
      this.ladyLeft = this.add.sprite(leftX + 100*this.scaleFactor, horizon, 'ladymacbeth')
        .setScale(charScale).setOrigin(0.5,1);

      // REALITY — derecha, también separados
      this.castleRight = this.add.sprite(rightX - 10*this.scaleFactor, horizon-130*this.scaleFactor, 'castle')
        .setScale(castleScale).setOrigin(0.5,1).setTint(0xcccccc);
      this.treesRight = this.add.sprite(rightX + 90*this.scaleFactor, horizon-110*this.scaleFactor, 'trees')
        .setScale(treesScale).setOrigin(0.5,1).setTint(0xcccccc);

      this.duncanRight = this.add.sprite(rightX - 100*this.scaleFactor, horizon, 'duncan')
        .setScale(charScale).setOrigin(0.5,1);

      this.macbethRight = this.add.sprite(rightX, horizon, 'macbethdoubting')
        .setScale(charScale).setOrigin(0.5,1);
      this.ladyRight = this.add.sprite(rightX + 100*this.scaleFactor, horizon, 'ladymacbethdark')
        .setScale(charScale).setOrigin(0.5,1);

      this.bloodRight = this.add.sprite(rightX - 35*this.scaleFactor, horizon-40*this.scaleFactor, 'blood')
        .setScale(0.30*this.scaleFactor).setOrigin(0.5,1);
      this.daggerRight = this.add.sprite(rightX + 55*this.scaleFactor, horizon-60*this.scaleFactor, 'dagger')
        .setScale(0.32*this.scaleFactor).setOrigin(0.5,1);

      // overlay oscuro derecha
      const darkOverlay = this.add.rectangle(
        rightX, horizon-60*this.scaleFactor,
        this.scale.width*0.44, this.scale.height*0.6,
        0x000000, 0.25
      ).setOrigin(0.5,0.5);

      // grupo para controlar visibilidad
      this.columnsGroup = this.add.group([
        this.castleLeft, this.treesLeft, this.duncanLeft, this.macbethLeft, this.ladyLeft,
        this.castleRight, this.treesRight, this.duncanRight, this.macbethRight, this.ladyRight,
        this.bloodRight, this.daggerRight, darkOverlay
      ]);

      this.columnsGroup.setAlpha(0);

      // preparar minijuego
      this.prepareDifferences();
    }

    prepareDifferences() {
      const highlightStroke = 0xd4af37;

      const makeBoxAroundSprite = (sprite) => {
        const g = this.add.graphics();
        g.lineStyle(3, highlightStroke, 1);
        const padding = 8 * this.scaleFactor;
        const w = sprite.displayWidth + padding;
        const h = sprite.displayHeight + padding;
        g.strokeRoundedRect(sprite.x - w/2, sprite.y - h, w, h, 16);
        g.setAlpha(0);
        return g;
      };

      const makeDiff = (spriteRight, message, pairSpriteLeft) => {
        spriteRight.setInteractive({ useHandCursor:true });

        const boxRight = makeBoxAroundSprite(spriteRight);
        const boxLeft  = makeBoxAroundSprite(pairSpriteLeft);

        const item = { sprite:spriteRight, found:false, boxes:[boxRight, boxLeft], message };
        this.differenceItems.push(item);

        spriteRight.on('pointerdown', () => {
          if (item.found) return;
          item.found = true;
          this.foundCount++;

          this.tweens.add({
            targets:item.boxes,
            alpha:1,
            duration:220
          });

          this.showInfo(message);
          this.updateCounter();

          if (this.foundCount >= this.totalDifferences) {
            this.time.delayedCall(1200, () => this.finishGame());
          }
        });
      };

      // Lady Macbeth diferente
      makeDiff(
        this.ladyRight,
        "Lady Macbeth looks kind on the left,\nbut on the right she hides a darker heart.",
        this.ladyLeft
      );

      // Macbeth dudando
      makeDiff(
        this.macbethRight,
        "Macbeth smiles on the left,\nbut on the right he is full of doubt.",
        this.macbethLeft
      );

      // Sangre vs castillo limpio
      makeDiff(
        this.bloodRight,
        "On the left the castle looks clean.\nOn the right we see blood. Danger is near.",
        this.castleLeft
      );

      // Daga vs árboles tranquilos
      makeDiff(
        this.daggerRight,
        "On the left everything seems safe.\nOn the right a dagger appears, ready for a crime.",
        this.treesLeft
      );
    }

    playIntro() {
      const w = this.scale.width;
      const h = this.scale.height;

      const lines = [
        'King Duncan arrives at Macbeth’s castle.',
        'He thinks the place is beautiful and safe.',
        'Banquo says the air is gentle and the birds sing.',
        'Lady Macbeth smiles and welcomes the king.',
        'But the audience knows there is a dark secret inside.'
      ];

      let step = 0;

      const showNext = () => {
        if (step >= lines.length) {
          this.time.delayedCall(1500, () => this.startGameIntro());
          return;
        }

        this.narrText.setText(lines[step]);
        this.narrText.setAlpha(0);
        this.narrText.y = h*0.14 + 10*this.scaleFactor;

        this.tweens.add({
          targets:this.narrText,
          alpha:1,
          y:h*0.14,
          duration:400,
          ease:'Quad.easeOut',
          onComplete: () => {
            this.time.delayedCall(3500, () => {
              this.tweens.add({
                targets:this.narrText,
                alpha:0,
                duration:300,
                ease:'Quad.easeIn',
                onComplete: () => {
                  step++;
                  showNext();
                }
              });
            });
          }
        });
      };

      showNext();
    }

    startGameIntro() {
      const w = this.scale.width;
      const h = this.scale.height;

      this.narrText.setText('Now look carefully.\nCan you see the difference between APPEARANCE and REALITY?');
      this.narrText.y = h*0.14;
      this.narrText.setAlpha(0);

      this.tweens.add({
        targets:this.narrText,
        alpha:1,
        duration:500
      });

      // mostrar columnas
      this.tweens.add({
        targets:this.columnsGroup.getChildren(),
        alpha:1,
        duration:600,
        delay:300
      });

      // contador
      this.counterText = this.add.text(
        w/2, h*0.23,
        'Differences found: 0 / 4',
        {
          fontFamily:'system-ui, sans-serif',
          fontSize:(18*this.scaleFactor)+'px',
          color:'#ffffff'
        }
      ).setOrigin(0.5).setAlpha(0);

      this.tweens.add({
        targets:this.counterText,
        alpha:1,
        duration:500,
        delay:400
      });

      // instrucciones
      this.time.delayedCall(800, () => {
        this.showInfo('Tap on the RIGHT side to spot the 4 differences.\nThey will light up on BOTH sides.');
      });
    }

    showInfo(text) {
      this.infoText.setText(text);
      this.infoText.setAlpha(0);

      this.tweens.add({
        targets:this.infoText,
        alpha:1,
        duration:250
      });
    }

    updateCounter() {
      if (!this.counterText) return;
      this.counterText.setText('Differences found: ' + this.foundCount + ' / ' + this.totalDifferences);
    }

    finishGame() {
      const w = this.scale.width;
      const h = this.scale.height;

      this.showInfo(
        'Well done!\nDuncan sees a friendly castle,\n' +
        'but you discovered the truth behind the smiles.'
      );

      const summary = this.add.text(
        w/2, h*0.72,
        "King Duncan trusts Macbeth and Lady Macbeth.\n" +
        "The castle looks peaceful, but a dark plan is hidden inside.",
        {
          fontFamily:'Georgia',
          fontSize:Phaser.Math.Clamp(20*this.scaleFactor,16,24)+'px',
          color:'#ffffff',
          align:'center',
          wordWrap:{ width:w*0.9 },
          lineSpacing: 10
        }
      ).setOrigin(0.5).setAlpha(0);

      this.tweens.add({
        targets:summary,
        alpha:1,
        duration:600
      });

      if (window.parent) {
        this.time.delayedCall(1800, () => {
          window.parent.postMessage({ type:'MACBETH_ENABLE_NEXT' }, '*');
        });
      }
    }
  }

  // ===== Config Phaser Responsive =====
  const config = {
    type: Phaser.AUTO,
    parent: 'game',
    width: 1600,          // tamaño virtual
    height: 900,
    backgroundColor: '#000000',
    pixelArt: true,
    roundPixels: true,
    powerPreference: 'high-performance',
    scale: {
      mode: Phaser.Scale.FIT,
      autoCenter: Phaser.Scale.CENTER_BOTH
    },
    scene: [Scene6SpotDifference]
  };

  const game = new Phaser.Game(config);
</script>
</body>
</html>
